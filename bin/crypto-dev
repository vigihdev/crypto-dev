#!/usr/bin/env php
<?php

use Defuse\Crypto\Key;

foreach ([__DIR__ . '/../../../autoload.php', __DIR__ . '/../vendor/autoload.php'] as $file) {
    if (file_exists($file)) {
        require $file;
        break;
    }
}

$argv = $_SERVER['argv'] ?? [];
$arg = array_slice($argv, 1);
$configDir = __DIR__ . '/../config';

if (!isset($arg[0]) || !realpath($configDir)) {
    exit;
}

$firstArg = $arg[0];
if ($firstArg === 'generate:key') {
    $secrets = $configDir . DIRECTORY_SEPARATOR . 'secrets';
    if (!is_dir($secrets)) {
        mkdir($secrets, 0700, true);
        chmod($secrets, 0700);
    }

    $filename = $secrets . DIRECTORY_SEPARATOR . '.defuse.key';
    $key = Key::createNewRandomKey();
    $content = $key->saveToAsciiSafeString();
    if ((bool)file_put_contents($filename, $content)) {
        chmod($filename, 0600);
        printf("Success Key berhasil di buat %s \n", $filename);
    }
}
